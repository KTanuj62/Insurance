# =============================================================================
# CONTINUOUS DEPLOYMENT (CD) PIPELINE
# =============================================================================
#
# This workflow runs after CI passes and deploys to Render.
#
# PREREQUISITES
# -------------
# Add this secret in GitHub (Settings → Secrets → Actions):
#   - RENDER_DEPLOY_HOOK_URL: Your Render deploy hook URL
#
# HOW TO GET RENDER DEPLOY HOOK:
#   1. Go to render.com and create a Web Service
#   2. Connect it to your GitHub repo
#   3. Go to Settings → Deploy Hook
#   4. Copy the URL and add it as a GitHub secret
#
# =============================================================================

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]

env:
  IMAGE_NAME: insurance-dashboard

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Verify Docker Image Exists
        run: |
          echo "Verifying image in Docker Hub..."
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
      
      - name: Deploy to Render
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "================================================"
            echo "RENDER_DEPLOY_HOOK_URL is not configured yet."
            echo ""
            echo "To enable automatic deployment:"
            echo "1. Create a Web Service on render.com"
            echo "2. Connect it to your GitHub repository"
            echo "3. Copy the Deploy Hook URL from Settings"
            echo "4. Add it as RENDER_DEPLOY_HOOK_URL in GitHub Secrets"
            echo "================================================"
            echo ""
            echo "Skipping deployment for now. CI completed successfully!"
            exit 0
          fi
          
          echo "Triggering Render deployment..."
          curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo ""
          echo "Deployment triggered! Check render.com for status."
